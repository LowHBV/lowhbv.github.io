<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°ä»£æ–‡æœ¬ç¼–è¾‘å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        :root {
            --bg-color: #1a1f25;
            --text-color: #ffffff;
            --secondary-bg: rgba(255,255,255,0.1);
            --border-color: rgba(255,255,255,0.2);
            --line-number-color: rgba(255,255,255,0.3);
            --line-number-bg: rgba(0,0,0,0.15);
            --line-number-border: rgba(255,255,255,0.1);
            --line-number-active: #4aa3ff;
            --search-bg: rgba(255,255,255,0.1);
            --search-border: rgba(255,255,255,0.2);
            --search-highlight: rgba(255,235,59,0.3);
            --text-secondary: rgba(255,255,255,0.6);
        }

        [data-theme="light"] {
            --bg-color: #f8f9fa;
            --text-color: #2d3436;
            --secondary-bg: rgba(0,0,0,0.04);
            --border-color: rgba(0,0,0,0.12);

            /* æ–°å¢æµ…è‰²æ¨¡å¼ä¸“ç”¨é¢œè‰² */
            --accent-blue: #3c3b3b;
            --hover-bg: rgba(25, 113, 194, 0.08);
            --active-bg: rgba(25, 113, 194, 0.15);
            --line-number-color: rgba(0,0,0,0.3);
            --line-number-bg: rgba(0,0,0,0.05);
            --line-number-border: rgba(0,0,0,0.1);
            --line-number-active: #1971c2;
            --search-bg: rgba(0,0,0,0.05);
            --search-highlight: rgba(255,235,59,0.5);
            --text-secondary: rgba(0,0,0,0.6);
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-color) 0%, var(--bg-color) 100%);
            padding: 20px;
            color: var(--text-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: row;
            border-radius: 20px;
            gap: 15px;
        }

        .menu-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px 15px 0 0;
            padding: 15px;
            display: flex;
            gap: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            justify-content: space-between;
        }

        .menu-item {
            color: #fff;
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .editor-container {
            flex: 1;
            background: var(--secondary-bg);
            backdrop-filter: blur(10px);
            border-radius: 0 0 15px 15px;
            padding: 20px 30px;
            border: 1px solid var(--border-color);
            position: relative;
            --editor-font-size: 16px;
            --editor-font-family: system-ui;
        }

        #editor {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-size: var(--editor-font-size) !important;
            font-family: var(--editor-font-family), monospace !important;
            line-height: 1.7;
            resize: none;
            outline: none;
            padding: 0 15px;
        }

        #editor::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .status-bar {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 10px;
            border-radius: 8px;
            display: none;
        }

        .button {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .container {
                height: calc(100vh - 20px);
                border-radius: 15px;
                display: flex; /* ç¡®ä¿containeræ˜¯flexå®¹å™¨ */
            }

            .menu-bar {
                flex-wrap: wrap;
            }

            .sidebar {
                width: 180px;
                display: none; /* é»˜è®¤éšè—å·¦ä¾§è¾¹æ  */
            }

            .toolbar {
                display: none; /* é»˜è®¤éšè—å³ä¾§å·¥å…·æ  */
                transition: all 0.3s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
                opacity: 0; /* åˆå§‹é€æ˜åº¦ä¸º0 */
                width: 220px; /* ç¡®ä¿å®½åº¦ */
            }

            /* å±•å¼€çŠ¶æ€ä¸‹æ˜¾ç¤ºå¹¶æ¢å¤é€æ˜åº¦ */
            .container.toolbar-expanded .toolbar {
                display: flex;
                opacity: 1;
            }

            #globalUserInfo {
                top: 10px;
                left: 10px;
                transform: scale(0.8);
                transform-origin: left top;
            }

            .container {
                margin-top: 60px !important;
            }

            /* æ–°å¢å±•å¼€çŠ¶æ€çš„æ ·å¼ */
            .container.sidebar-expanded .sidebar {
                display: block;
            }

            .container.toolbar-expanded .toolbar {
                display: flex;
            }

            /* æ‰‹æœºæ¨¡å¼ä¸‹ï¼Œæœªå±•å¼€è¾¹æ æ—¶æ˜¾ç¤ºtoggle bar */
            .container:not(.sidebar-expanded) #sidebarToggleBar {
                display: block;
            }

            .container:not(.toolbar-expanded) #toolbarToggleBar {
                display: block;
            }

            /* æ‰‹æœºæ¨¡å¼ä¸‹ï¼ŒeditoråŒºåŸŸå æ®å‰©ä½™ç©ºé—´ */
            .editor-container {
                flex: 1;
            }

            /* è°ƒæ•´å±•å¼€æ¡çš„ä½ç½® */
            #sidebarToggleBar {
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 2; /* ç¡®ä¿åœ¨editorä¹‹ä¸Š */
                width: 6px; /* è®¾ç½®å®½åº¦ */
                padding: 5px 0; /* è°ƒæ•´padding */
                text-align: center; /* æ–‡æœ¬å±…ä¸­ */
                border-radius: 5px 0 0 5px; /* è°ƒæ•´åœ†è§’ */
                font-size: 12px; /* è°ƒæ•´å­—ä½“å¤§å° */
            }

            #toolbarToggleBar {
                position: absolute;
                right: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 2; /* ç¡®ä¿åœ¨editorä¹‹ä¸Š */
                width: 6px; /* è®¾ç½®å®½åº¦ */
                padding: 5px 0; /* è°ƒæ•´padding */
                text-align: center; /* æ–‡æœ¬å±…ä¸­ */
                border-radius: 0 5px 5px 0; /* è°ƒæ•´åœ†è§’ */
                font-size: 12px; /* è°ƒæ•´å­—ä½“å¤§å° */
            }
        }

        /* æ–°å¢å·¦ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            overflow-y: auto;
            border-radius: 15px 0 0 15px;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            color: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .file-item.active {
            background: rgba(74, 144, 226, 0.3);
            color: #fff;
        }

        /* æ–°å¢æ ¼å¼é€‰æ‹©å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 25px;
            border-radius: 15px;
            width: 300px;
        }

        .format-option {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .format-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .logout-button {
            background: rgba(255, 75, 75, 0.2);
            border-color: rgba(255, 75, 75, 0.3);
        }

        .logout-button:hover {
            background: rgba(255, 75, 75, 0.3);
        }

        /* æ–°å¢é”™è¯¯æç¤ºæ ·å¼ */
        .error-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4757;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }

        /* æ–°å¢å¼€å…³æ ·å¼ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.2);
            transition: .4s;
            border-radius: 12px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-label {
            color: white;
            font-size: 14px;
            margin-right: 10px;
        }

        /* åœ¨åŸæœ‰å¼€å…³æ ·å¼ä¸‹æ–°å¢ */
        .ide-toggle {
            margin-left: 15px;
        }

        /* æ–°å¢å³ä¾§å·¥å…·æ æ ·å¼ */
        .toolbar {
            width: 220px;
            background: rgba(0, 0, 0, 0.2);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 0 15px 15px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .toolbar-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .toolbar-title {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* æ–°å¢å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: absolute;
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            backdrop-filter: blur(20px) saturate(180%);
        }

        .menu-item {
            color: rgba(255,255,255,0.8);
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .menu-divider {
            border-top: 1px solid rgba(255,255,255,0.1);
            margin: 4px 0;
        }

        /* åœ¨å·¥å…·æ æ·»åŠ ä¸»é¢˜åˆ‡æ¢ */
        .toolbar-section:last-child {
            text-align: right;
        }

        .theme-select {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            cursor: pointer;
        }

        .user-info {
            transition: all 0.3s ease;
            padding: 5px 10px;
            border-radius: 8px;
        }

        .user-info:hover {
            background: rgba(255,255,255,0.1);
        }

        #avatarPath {
            margin-top: 8px;
            border-radius: 6px;
            font-size: 13px;
        }

        .file-item.folder {
            color: #4aa3ff;
            font-weight: 500;
        }

        .file-item.folder:hover {
            background: rgba(74, 163, 255, 0.1);
        }

        /* æµ…è‰²æ¨¡å¼è¦†ç›–æ ·å¼ */
        [data-theme="light"] {
            .sidebar {
                background: rgba(255,255,255,0.7);
                border-right-color: rgba(0,0,0,0.08);
            }

            .file-item:hover {
                background: var(--hover-bg);
            }

            .file-item.active {
                background: var(--active-bg);
                color: var(--accent-blue);
            }

            .button {
                background: rgba(255,255,255,0.9);
                color: var(--text-color);
                border-color: var(--border-color);
            }

            .button:hover {
                background: rgba(255,255,255,0.95);
            }

            .modal-content,
            .context-menu,
            .search-panel {
                background: rgba(255,255,255,0.9) !important;
                border-color: rgba(0,0,0,0.08);
            }

            .menu-item {
                color: var(--text-color);
            }

            .menu-item:hover {
                background: var(--hover-bg);
            }

            .toggle-slider {
                background-color: rgba(0,0,0,0.1);
            }

            .file-item.folder {
                color: var(--accent-blue);
            }

            .error-toast {
                background: #ff6b6b;
                color: white;
            }

            #editor {
                color: var(--text-color);
            }

            #editor::placeholder {
                color: rgba(45, 52, 54, 0.4);
            }

            #lineNumbers {
                color: rgba(0,0,0,0.3);
            }
        }

        #lineNumbers div {
            position: relative;
            padding-right: 10px;
            transition: color 0.2s ease;
        }

        #lineNumbers div::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 60%;
            background: var(--line-number-border);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        #lineNumbers div:hover {
            color: var(--line-number-active);
        }

        #lineNumbers div.active-line {
            color: var(--line-number-active);
            font-weight: 500;
        }

        #lineNumbers div.active-line::after {
            opacity: 1;
        }

        .highlight {
            background: var(--search-highlight);
            border: 1px solid rgba(255,235,59,0.5);
            border-radius: 3px;
        }

        .current-highlight {
            background: rgba(255,235,59,0.6);
            border-color: rgba(255,235,59,0.8);
        }

        /* æ–°å¢å¯æ‹–åŠ¨æœç´¢é¢æ¿æ ·å¼ */
        .search-panel {
            position: fixed;
            top: 100px;
            left: 100px;
            min-width: 400px;
            width: max-content;
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            cursor: move;
            user-select: none;
            backdrop-filter: blur(20px) saturate(180%);
        }

        .search-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-panel-content {
            min-width: 380px;
        }

        .search-panel-close {
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s ease;
        }

        .search-panel-close:hover {
            background: rgba(255,255,255,0.1);
        }

        /* æ–°å¢å­—ä½“æ§åˆ¶æ ·å¼ */
        .font-control {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 13px;
            cursor: pointer;
        }

        /* æµ…è‰²æ¨¡å¼é€‚é… */
        [data-theme="light"] .font-control {
            background: rgba(255,255,255,0.9);
            border-color: var(--border-color);
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
            background: var(--secondary-bg);
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 4px;
        }

        .button.danger {
            background: #dc3545;
            border-color: #dc3545;
        }

        .button.danger:hover {
            background: #bb2d3b;
        }

        /* æ–°å¢ç»Ÿä¸€å¼¹çª—æ¨¡ç³Šæ•ˆæœ */
        .context-menu,
        .search-panel,
        #fileContextMenu {
            backdrop-filter: blur(20px) saturate(180%);
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.15);
        }

        /* æµ…è‰²æ¨¡å¼é€‚é… */
        [data-theme="light"] {
            .modal-content,
            .context-menu,
            .search-panel {
                background: rgba(255,255,255,0.9) !important;
                border-color: rgba(0,0,0,0.08);
            }
        }
    </style>
</head>
<body>
<!-- æ–°å¢å›ºå®šå®šä½çš„ç”¨æˆ·ä¿¡æ¯ -->
<div id="globalUserInfo" style="position: fixed; top: 20px; left: 20px; z-index: 1000; display: flex; align-items: center; gap: 10px;">
    <img id="userAvatar" src="./default-avatar.png"
         style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border-color);">
    <span id="username" style="color: var(--text-color); font-size: 16px; font-weight: 500; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">LowHBV</span>
</div>

<!-- åœ¨æ ¼å¼é€‰æ‹©å¼¹çª—å‰æ–°å¢æ–°å»ºæ–‡ä»¶å¼¹çª— -->
<div class="modal-overlay" id="newFileModal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="color: #fff; margin-bottom: 20px;">æ–°å»ºæ–‡ä»¶</h3>

        <!-- æ–‡ä»¶åè¾“å…¥ -->
        <div style="margin-bottom: 20px;">
            <input type="text" id="newFileName"
                   style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;"
                   placeholder="è¾“å…¥æ–‡ä»¶åï¼ˆæ— éœ€æ‰©å±•åï¼‰">
        </div>

        <!-- å¯†ç è¾“å…¥ -->
        <div style="margin: 10px 0;">
            <input type="password" id="filePassword"
                   style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--secondary-bg); color: var(--text-color);"
                   placeholder="æ–‡ä»¶å¯†ç ï¼ˆå¯é€‰ï¼‰">
        </div>

        <!-- æ ¼å¼é€‰æ‹© -->
        <div class="toolbar-section" style="margin-bottom: 20px;">
            <div class="toolbar-title">é€‰æ‹©æ ¼å¼</div>
            <!-- æ–°å¢è‡ªå®šä¹‰æ ¼å¼è¾“å…¥ -->
            <div style="margin: 10px 0;">
                <input type="text" id="customFormat"
                       style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;"
                       placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰æ ¼å¼ï¼ˆå¦‚ï¼šjsï¼‰">
            </div>
            <!-- åŸæœ‰æ ¼å¼é€‰é¡¹ä¿æŒä¸å˜ -->
            <div class="format-option" data-format="txt">
                <span style="color: #fff;">æ–‡æœ¬æ–‡ä»¶ (.txt)</span>
            </div>
            <div class="format-option" data-format="html">
                <span style="color: #fff;">HTML æ–‡ä»¶ (.html)</span>
            </div>
            <div class="format-option" data-format="md">
                <span style="color: #fff;">Markdown æ–‡ä»¶ (.md)</span>
            </div>
            <div class="format-option" data-format="hty">
                <span style="color: #fff;">ç»˜å›¾æ–‡ä»¶ (.hty)</span>
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="button" onclick="createCustomFile()" style="flex:1;">åˆ›å»º</button>
            <button class="button" onclick="closeNewFileModal()" style="flex:1;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- æ–°å¢å¯¼å‡ºèœå•å¼¹çª— -->
<div class="modal-overlay" id="exportModal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="color: #fff; margin-bottom: 20px;">å¯¼å‡ºæ–‡ä»¶è®¾ç½®</h3>

        <!-- æ–‡ä»¶åè¾“å…¥ -->
        <div style="margin-bottom: 20px;">
            <input type="text" id="exportFileName"
                   style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;"
                   placeholder="è¾“å…¥æ–‡ä»¶å">
        </div>

        <!-- æ ¼å¼é€‰æ‹© -->
        <div class="toolbar-section" style="margin-bottom: 20px;">
            <div class="toolbar-title">é€‰æ‹©æ ¼å¼</div>
            <div class="format-option" data-format="current">
                <span style="color: #fff;">å½“å‰æ ¼å¼ (.${currentFile?.format})</span>
            </div>
            <div class="format-option" data-format="txt">
                <span style="color: #fff;">æ–‡æœ¬æ–‡ä»¶ (.txt)</span>
            </div>
            <div class="format-option" data-format="html">
                <span style="color: #fff;">HTML æ–‡ä»¶ (.html)</span>
            </div>
            <div class="format-option" data-format="md">
                <span style="color: #fff;">Markdown æ–‡ä»¶ (.md)</span>
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="button" onclick="handleExport()" style="flex:1;">å¯¼å‡º</button>
            <button class="button" onclick="closeExportModal()" style="flex:1;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- æ–°å¢æ–°å»ºæ–‡ä»¶å¤¹å¼¹çª— -->
<div class="modal-overlay" id="newFolderModal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="color: var(--text-color); margin-bottom: 20px;">æ–°å»ºæ–‡ä»¶å¤¹</h3>
        <div style="margin-bottom: 20px;">
            <input type="text" id="folderNameInput"
                   style="width: 100%; padding: 8px; border-radius: 6px;
                              border: 1px solid var(--border-color);
                              background: var(--secondary-bg);
                              color: var(--text-color);"
                   placeholder="è¾“å…¥æ–‡ä»¶å¤¹åç§°"
                   onkeypress="if(event.keyCode === 13) confirmCreateFolder()">
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="button" onclick="confirmCreateFolder()" style="flex:1;">åˆ›å»º</button>
            <button class="button" onclick="closeNewFolderModal()" style="flex:1;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div class="container" style="margin-top: 80px;">
    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="button" onclick="showNewFileModal()" style="flex:1;">æ–°å»ºæ–‡ä»¶</button>
            <button class="button" onclick="createNewFolder()" style="flex:1;">æ–°å»ºæ–‡ä»¶å¤¹</button>
        </div>
        <div class="file-list" id="fileList"></div>
    </div>

    <!-- å·¦ä¾§è¾¹æ å±•å¼€æ¡ -->
    <div class="sidebar-toggle-bar" id="sidebarToggleBar" onclick="toggleSidebar()"
         style="display: none; cursor: pointer; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 10px 0 0 10px; color: white;">
        &gt;
    </div>

    <!-- ä¸»ç¼–è¾‘å™¨åŒºåŸŸ -->
    <div style="flex: 1; display: flex; flex-direction: column;">
        <div class="menu-bar">
            <div style="display: flex; gap: 20px; align-items: center;">
                <button class="button" onclick="saveFile()">ä¿å­˜</button>
                <button class="button" onclick="downloadFile()">ä¸‹è½½</button>
                <!-- æ–°å¢å±•å¼€/æŠ˜å æŒ‰é’® -->
                <button class="button" onclick="toggleSidebar()" id="sidebarToggleButton">å±•å¼€å·¦ä¾§</button>
                <button class="button" onclick="toggleToolbar()" id="toolbarToggleButton">å±•å¼€å³ä¾§</button>
                <button class="button" onclick="showAuditLog()" style="margin-left: auto;">å®¡è®¡æ—¥å¿—</button>
            </div>
            <button class="button logout-button" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
        <div class="editor-container">
            <!-- æ·»åŠ è¡Œå·å®¹å™¨ -->
            <div id="lineNumbers" style="
                    position: absolute;
                    left: 0;
                    top: 0;
                    bottom: 0;
                    width: 45px;
                    padding: 20px 0;
                    font-size: var(--editor-font-size);
                    line-height: 1.7;
                    color: var(--line-number-color);
                    text-align: center;
                    user-select: none;
                    display: none;
                    background: var(--line-number-bg);
                    border-right: 1px solid var(--line-number-border);
                    z-index: 1;
                    overflow: hidden;
                "></div>
            <textarea id="editor" placeholder="å¼€å§‹è¾“å…¥..." style="padding-left: 50px !important;"></textarea>
            <!-- Canvas for drawing -->
            <canvas id="htyCanvas" style="display: none; width: 100%; height: 100%; background-color: white;"></canvas>
            <div class="status-bar" id="status">å·²ä¿å­˜</div>
        </div>
    </div>

    <!-- å³ä¾§å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-section">
            <div class="toolbar-title">ç¼–è¾‘è®¾ç½®</div>
            <!-- è‡ªåŠ¨ä¿å­˜å¼€å…³ -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="toggle-label">è‡ªåŠ¨ä¿å­˜</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoSaveToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- IDEæ¨¡å¼å¼€å…³ -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <span class="toggle-label">IDEæ¨¡å¼</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="ideModeToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- æ–°å¢è¡Œå·æ˜¾ç¤ºå¼€å…³ -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <span class="toggle-label">æ˜¾ç¤ºè¡Œå·</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="lineNumberToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- æ–°å¢æ‹¼å†™æ£€æŸ¥å¼€å…³ -->
            <label class="toggle-switch" style="margin-top: 15px;">
                <input type="checkbox" id="spellCheckToggle" onchange="toggleSpellCheck()">
                <span class="toggle-slider"></span>
                <span style="color: var(--text-color); margin-left: 8px;">æ‹¼å†™æ£€æŸ¥</span>
            </label>
            <!-- æ–°å¢ç”»ç¬”é¢œè‰²é€‰æ‹© -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <span class="toggle-label">ç”»ç¬”é¢œè‰²</span>
                <input type="color" id="penColorPicker" value="#000000" style="width: 40px; height: 25px; background: var(--secondary-bg); border: 1px solid var(--border-color);"/>
            </div>
        </div>
        <div class="toolbar-section">
            <div class="toolbar-title">æ–‡æœ¬è®¾ç½®</div>
            <!-- æ–°å¢å­—å·é€‰æ‹© -->
            <div style="margin-bottom: 10px;">
                <select class="font-control" id="fontSizeSelect" onchange="updateFontSize(this.value)">
                    <option value="14">14px</option>
                    <option value="16">16px</option>
                    <option value="18">18px</option>
                    <option value="20">20px</option>
                </select>
            </div>

            <!-- æ–°å¢å­—ä½“é€‰æ‹© -->
            <div>
                <select class="font-control" id="fontFamilySelect" onchange="updateFontFamily(this.value)">
                    <option value="system-ui">ç³»ç»Ÿé»˜è®¤</option>
                    <option value="Consolas">Consolas</option>
                    <option value="Monaco">Monaco</option>
                    <option value="'Courier New'">Courier New</option>
                </select>
            </div>
        </div>
        <div class="toolbar-section">
            <div class="toolbar-title">æ–‡ä»¶æ“ä½œ</div>
            <button class="button" onclick="handleFileOpen()">æ‰“å¼€æœ¬åœ°æ–‡ä»¶</button>
            <button class="button" onclick="handleFileSave()" style="margin-top:10px;">ä¿å­˜åˆ°æœ¬åœ°</button>
        </div>
        <div class="toolbar-section">
            <div class="toolbar-title">ç•Œé¢ä¸»é¢˜</div>
            <select class="theme-select" onchange="toggleTheme(this.value)">
                <option value="dark">æ·±è‰²æ¨¡å¼</option>
                <option value="light">æµ…è‰²æ¨¡å¼</option>
            </select>
        </div>
        <div class="toolbar-section">
            <div class="toolbar-title">ç”¨æˆ·è®¾ç½®</div>
            <!-- æ–°å¢ç”¨æˆ·åè¾“å…¥ -->
            <input type="text" id="userNameInput"
                   style="width: 100%; padding: 6px; background: var(--secondary-bg);
                              border: 1px solid var(--border-color); color: var(--text-color);"
                   placeholder="è¾“å…¥ç”¨æˆ·å">
            <button class="button" onclick="saveUserName()" style="margin-top: 10px;">ä¿å­˜ç”¨æˆ·</button>
            <!-- åŸæœ‰å¤´åƒè®¾ç½®ä¿æŒä¸å˜ -->
            <input type="text" id="avatarPath"
                   style="width: 100%; padding: 6px; background: var(--secondary-bg);
                              border: 1px solid var(--border-color); color: var(--text-color);"
                   placeholder="å¤´åƒURL">
            <button class="button" onclick="updateAvatar()" style="margin-top: 10px;">æ›´æ–°å¤´åƒ</button>
        </div>
        <div class="toolbar-section">
            <div class="toolbar-title">æœç´¢åŠŸèƒ½</div>
            <!-- æ”¹ä¸ºå¼€å…³å½¢å¼ -->
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span class="toggle-label">æœç´¢é¢æ¿</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="searchPanelToggle" onchange="toggleSearchPanel()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- å³ä¾§å·¥å…·æ å±•å¼€æ¡ -->
    <div class="toolbar-toggle-bar" id="toolbarToggleBar" onclick="toggleToolbar()"
         style="display: none; cursor: pointer; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 0 10px 10px 0; color: white;">
        &lt;
    </div>
</div>

<!-- åœ¨bodyå†…æ·»åŠ é”™è¯¯æç¤º -->
<div class="error-toast" id="errorToast"></div>

<!-- åœ¨bodyåº•éƒ¨æ·»åŠ å³é”®èœå• -->
<div class="context-menu" id="fileContextMenu">
    <div class="menu-item" onclick="showNewFileModal()">æ–°å»ºæ–‡ä»¶</div>
    <div class="menu-item" onclick="createNewFolder()">æ–°å»ºæ–‡ä»¶å¤¹</div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="renameFile()">é‡å‘½å</div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="deleteFile()">åˆ é™¤</div>
    <div class="menu-item" onclick="exportFile()">å¯¼å‡ºä¸º...</div>
</div>

<!-- æ·»åŠ å®¡è®¡æ—¥å¿—å¼¹çª— -->
<div class="modal-overlay" id="auditLogModal">
    <div class="modal-content" style="width: 80vw; height: 80vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--text-color);">æ“ä½œæ—¥å¿— (å…±${auditLogs.length}æ¡)</h3>
            <button class="button danger" onclick="handleClearLogs()" style="margin-left: 20px;">æ¸…é™¤æ—¥å¿—</button>
        </div>
        <div id="auditLogList" style="flex: 1; overflow-y: auto; padding-right: 10px;">
            <!-- æ—¥å¿—é¡¹æ¨¡æ¿ -->
            <div class="log-item" style="padding: 12px; margin-bottom: 8px; background: var(--secondary-bg); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary); font-size: 12px;">[æ—¶é—´]</span>
                    <span style="color: var(--accent-blue); font-weight: 500;">[æ“ä½œç±»å‹]</span>
                </div>
                <div style="margin-top: 6px;">[æ–‡ä»¶å]</div>
                <div style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">æ“ä½œäºº: [ç”¨æˆ·]</div>
            </div>
        </div>
        <button class="button" onclick="closeAuditModal()" style="align-self: flex-end; margin-top: 20px;">å…³é—­</button>
    </div>
</div>

<!-- åœ¨bodyæœ«å°¾æ·»åŠ æœç´¢é¢æ¿ -->
<div class="search-panel" id="searchPanel" style="display: none;">
    <div class="search-panel-header">
        <div>æ–‡æœ¬æœç´¢</div>
        <div class="search-panel-close" onclick="toggleSearchPanel()">Ã—</div>
    </div>
    <div class="search-panel-content">
        <div style="position: relative; margin-bottom: 15px;">
            <input type="text" id="searchInput"
                   style="width: 100%;
                              padding: 8px 40px 8px 15px;
                              background: var(--search-bg);
                              border: 1px solid var(--search-border);
                              color: var(--text-color);
                              font-size: 14px;
                              border-radius: 8px;"
                   placeholder="è¾“å…¥æœç´¢å†…å®¹...">
            <div id="searchMatches"
                 style="position: absolute;
                            right: 15px;
                            top: 50%;
                            transform: translateY(-50%);
                            font-size: 12px;
                            color: var(--text-secondary);">
                0/0
            </div>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 10px;">
            <div style="display: flex; align-items: center;">
                <span class="toggle-label">åŒºåˆ†å¤§å°å†™</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="caseSensitiveToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <button class="button" onclick="findNext()" style="padding: 6px 12px;">ä¸‹ä¸€ä¸ª</button>
            <button class="button" onclick="findPrev()" style="padding: 6px 12px;">ä¸Šä¸€ä¸ª</button>
        </div>
    </div>
</div>

<script>
    const editor = document.getElementById('editor');
    const status = document.getElementById('status');
    let timeoutId;

    // æ–°å¢æ–‡ä»¶ç®¡ç†åŠŸèƒ½
    let files = JSON.parse(localStorage.getItem('editorFiles')) || [];
    let currentFile = null;

    // æ–°å¢è‡ªåŠ¨ä¿å­˜çŠ¶æ€
    let autoSaveEnabled = true;
    const autoSaveToggle = document.getElementById('autoSaveToggle');

    // æ–°å¢IDEæ¨¡å¼çŠ¶æ€
    let ideModeEnabled = false;
    const ideModeToggle = document.getElementById('ideModeToggle');

    // æ–°å¢æœ¬åœ°æ–‡ä»¶æ“ä½œé€»è¾‘
    let fileHandle = null;

    // æ–°å¢å†å²è®°å½•åŠŸèƒ½
    let historyTimeout;
    function recordHistory() {
        if (!currentFile) return;

        currentFile.history = currentFile.history || [];
        currentFile.history.push(editor.value);

        // ä¿ç•™æœ€è¿‘50ä¸ªç‰ˆæœ¬
        if (currentFile.history.length > 50) {
            currentFile.history.shift();
        }

        // é˜²æŠ–å¤„ç†ï¼Œæ¯5ç§’è®°å½•ä¸€æ¬¡
        clearTimeout(historyTimeout);
        historyTimeout = setTimeout(() => {
            localStorage.setItem('editorFiles', JSON.stringify(files));
        }, 5000);
    }

    // æ–°å¢æ–‡ä»¶å˜æ›´æ£€æµ‹
    let lastSavedContent = '';

    function checkFileChange() {
        if (currentFile && editor.value !== lastSavedContent) {
            showStatus('æ£€æµ‹åˆ°æœªä¿å­˜çš„æ›´æ”¹');
            document.title = `* ${currentFile.name} - ç°ä»£æ–‡æœ¬ç¼–è¾‘å™¨`;
        }
    }

    // å®šæ—¶æ£€æµ‹ï¼ˆæ¯2ç§’ï¼‰
    setInterval(checkFileChange, 2000);

    // åˆå§‹åŒ–è‡ªåŠ¨ä¿å­˜çŠ¶æ€
    window.addEventListener('load', () => {
        const savedState = localStorage.getItem('autoSaveEnabled');
        autoSaveEnabled = savedState !== null ? savedState === 'true' : true;
        autoSaveToggle.checked = autoSaveEnabled;
        if (files.length > 0) {
            currentFile = files[0];
            editor.value = currentFile.content;
        }
        const savedIdeMode = localStorage.getItem('ideModeEnabled');
        ideModeEnabled = savedIdeMode === 'true';
        ideModeToggle.checked = ideModeEnabled;
        initFileList();
    });

    // ç›‘å¬å¼€å…³å˜åŒ–
    autoSaveToggle.addEventListener('change', (e) => {
        autoSaveEnabled = e.target.checked;
        localStorage.setItem('autoSaveEnabled', autoSaveEnabled);
        showStatus(`è‡ªåŠ¨ä¿å­˜å·²${autoSaveEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
    });

    // ç›‘å¬IDEæ¨¡å¼å¼€å…³å˜åŒ–
    ideModeToggle.addEventListener('change', (e) => {
        ideModeEnabled = e.target.checked;
        localStorage.setItem('ideModeEnabled', ideModeEnabled);
        showStatus(`IDEæ¨¡å¼å·²${ideModeEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
    });

    // æ–°å¢å³é”®èœå•é€»è¾‘
    let contextMenuFile = null;

    document.addEventListener('click', () => {
        document.getElementById('fileContextMenu').style.display = 'none';
    });

    document.getElementById('fileList').addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const fileItem = e.target.closest('.file-item');
        if (fileItem) {
            contextMenuFile = files.find(f => f.id === fileItem.dataset.id);
            showContextMenu(e.clientX, e.clientY);
        }
    });

    function showContextMenu(x, y) {
        const menu = document.getElementById('fileContextMenu');
        menu.style.display = 'block';
        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
    }

    // æ–°å¢æ–‡ä»¶æ“ä½œåŠŸèƒ½
    function renameFile() {
        const newName = prompt('è¯·è¾“å…¥æ–°æ–‡ä»¶å:', contextMenuFile.name);
        if (newName && newName !== contextMenuFile.name) {
            contextMenuFile.name = newName;
            localStorage.setItem('editorFiles', JSON.stringify(files));
            initFileList();
            showStatus('æ–‡ä»¶åå·²ä¿®æ”¹');
        }
    }

    function deleteFile() {
        if (confirm(`ç¡®å®šè¦åˆ é™¤ ${contextMenuFile.name} å—ï¼Ÿ`)) {
            files = files.filter(f => f.id !== contextMenuFile.id);
            if (currentFile?.id === contextMenuFile.id) {
                currentFile = null;
                editor.value = '';
            }
            localStorage.setItem('editorFiles', JSON.stringify(files));
            initFileList();
            showStatus('æ–‡ä»¶å·²åˆ é™¤');
            logAction('DELETE', contextMenuFile.name);
        }
    }

    function exportFile() {
        const tempFile = currentFile;
        currentFile = contextMenuFile;
        downloadFile();
        currentFile = tempFile;
    }

    // åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨
    function initFileList() {
        const fileList = document.getElementById('fileList');

        // åˆ†ç¦»æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
        const folders = files.filter(f => f.type === 'folder');
        const normalFiles = files.filter(f => !f.type || f.type === 'file');

        fileList.innerHTML = [
            ...folders.map(folder => `
                    <div class="file-item folder" data-id="${folder.id}">
                        <span>ğŸ“ ${folder.name}</span>
                    </div>
                `),
            ...normalFiles.map(file => `
                    <div class="file-item ${file.id === currentFile?.id ? 'active' : ''}"
                         data-id="${file.id}"
                         onclick="openFile('${file.id}')">
                        <span>${file.name}</span>
                        ${file.passwordHash ? 'ğŸ”’' : ''}
                    </div>
                `)
        ].join('');
    }

    // ä¿®æ”¹æ–°å»ºæ–‡ä»¶æŒ‰é’®è°ƒç”¨æ–¹å¼
    function showNewFileModal() {
        document.getElementById('newFileName').value = '';
        document.getElementById('newFileModal').style.display = 'flex';
        // é‡ç½®æ ¼å¼é€‰æ‹©çŠ¶æ€
        document.querySelectorAll('#newFileModal .format-option').forEach(opt => {
            opt.style.background = opt.dataset.format === 'txt' ?
                'rgba(255,255,255,0.1)' : 'transparent';
        });
    }

    function closeNewFileModal() {
        document.getElementById('newFileModal').style.display = 'none';
    }

    // ä¿®æ”¹æ ¼å¼é€‰æ‹©é€»è¾‘
    let selectedFormat = 'txt';
    document.querySelectorAll('#newFileModal .format-option').forEach(option => {
        option.addEventListener('click', function() {
            selectedFormat = this.dataset.format;
            document.getElementById('customFormat').value = ''; // æ¸…ç©ºè‡ªå®šä¹‰è¾“å…¥
            document.querySelectorAll('#newFileModal .format-option').forEach(opt => {
                opt.style.background = opt === this ? 'rgba(255,255,255,0.1)' : 'transparent';
            });
        });
    });

    // ç›‘å¬è‡ªå®šä¹‰æ ¼å¼è¾“å…¥
    document.getElementById('customFormat').addEventListener('input', function(e) {
        if(e.target.value.trim()) {
            selectedFormat = e.target.value.replace(/[^a-z0-9]/gi, '').toLowerCase();
            document.querySelectorAll('#newFileModal .format-option').forEach(opt => {
                opt.style.background = 'transparent';
            });
        }
    });

    // æ›´æ–°æ–‡ä»¶åˆ›å»ºé€»è¾‘
    function createCustomFile() {
        const fileNameInput = document.getElementById('newFileName').value.trim();
        if (!fileNameInput) {
            showError('æ–‡ä»¶åä¸èƒ½ä¸ºç©º');
            return;
        }

        // å¤„ç†è‡ªå®šä¹‰æ ¼å¼
        let finalFormat = selectedFormat;
        if(document.getElementById('customFormat').value.trim()) {
            finalFormat = document.getElementById('customFormat').value
                .replace(/[^a-z0-9]/gi, '')
                .toLowerCase();
        }

        // æ ¼å¼æœ‰æ•ˆæ€§æ£€æŸ¥
        if(!finalFormat || finalFormat.length > 6) {
            showError('æ ¼å¼æ— æ•ˆï¼ˆ1-6ä½å­—æ¯æ•°å­—ï¼‰');
            return;
        }

        // è‡ªåŠ¨æ·»åŠ æ‰©å±•åï¼ˆå¦‚æœç”¨æˆ·æ²¡æœ‰è¾“å…¥ï¼‰
        let finalName = fileNameInput;
        if (!finalName.endsWith(`.${finalFormat}`)) {
            finalName += `.${finalFormat}`;
        }

        // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦å·²å­˜åœ¨
        if (files.some(f => f.name === finalName)) {
            showError('æ–‡ä»¶åå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
            return;
        }

        createNewFile(finalFormat, finalName);
        closeNewFileModal();
    }

    // ä¿®æ”¹åŸæœ‰createNewFileå‡½æ•°
    async function createNewFile(format, customName = null, password = '') {
        const fileName = customName || `æœªå‘½åæ–‡ä»¶_${files.length + 1}.${format}`;
        const newFile = {
            id: Date.now().toString(),
            name: fileName,
            content: format === 'hty' ? '' : '', // Initialize content for hty as empty string
            format: format,
            history: [],
            passwordHash: password ? await hashPassword(password) : null
        };
        if (format === 'hty') {
            newFile.content = ''; // Ensure hty content is initialized as empty string
        }

        files.push(newFile);
        currentFile = newFile;
        localStorage.setItem('editorFiles', JSON.stringify(files));
        editor.value = '';
        initFileList();
        showStatus('å·²åˆ›å»ºæ–°æ–‡ä»¶');
        logAction('CREATE', fileName);
    }

    // å¯†ç å“ˆå¸Œå‡½æ•°
    async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // æ‰“å¼€æ–‡ä»¶
    async function openFile(fileId) {
        const file = files.find(f => f.id === fileId);

        // å¯†ç éªŒè¯é€»è¾‘
        if (file?.passwordHash) {
            const password = prompt('è¯·è¾“å…¥æ–‡ä»¶å¯†ç :');
            if (!password) {
                showError('å¿…é¡»è¾“å…¥å¯†ç ');
                return; // é˜»æ­¢æœªè¾“å…¥å¯†ç çš„è®¿é—®
            }

            const inputHash = await hashPassword(password);
            if (inputHash !== file.passwordHash) {
                showError('å¯†ç é”™è¯¯');
                return; // å¯†ç é”™è¯¯æ—¶ç»ˆæ­¢æ“ä½œ
            }
        }

        // åªæœ‰é€šè¿‡éªŒè¯æ‰ä¼šæ‰§è¡Œæ‰“å¼€æ“ä½œ
        if (file) {
            currentFile = file;
            if (file.format === 'hty') {
                switchToCanvasMode();
                loadCanvasContent(file.content); // Load saved drawing if any
            } else {
                switchToEditorMode();
                editor.value = file.content;
            }
            initFileList();
            logAction('OPEN', file.name); // è®°å½•å®¡è®¡æ—¥å¿—
        }
    }

    // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
    function showStatus(message) {
        status.textContent = message;
        status.style.display = 'block';
        setTimeout(() => {
            status.style.display = 'none';
        }, 2000);
    }

    // ä¿®æ”¹åçš„å¯¼å‡ºåŠŸèƒ½é€»è¾‘
    let exportFormat = 'current';

    function showExportMenu() {
        const defaultName = currentFile?.name.replace(/\.[^/.]+$/, '') || 'æœªå‘½åæ–‡ä»¶';
        document.getElementById('exportFileName').value = defaultName;
        document.getElementById('exportModal').style.display = 'flex';

        // è®¾ç½®é»˜è®¤é€‰ä¸­å½“å‰æ ¼å¼
        document.querySelectorAll('.format-option').forEach(option => {
            option.style.background = option.dataset.format === 'current' ?
                'rgba(255,255,255,0.1)' : 'transparent';
        });
    }

    function closeExportModal() {
        document.getElementById('exportModal').style.display = 'none';
    }

    document.querySelectorAll('#exportModal .format-option').forEach(option => {
        option.addEventListener('click', function() {
            exportFormat = this.dataset.format;
            document.querySelectorAll('#exportModal .format-option').forEach(opt => {
                opt.style.background = opt === this ? 'rgba(255,255,255,0.1)' : 'transparent';
            });
        });
    });

    function handleExport() {
        const fileNameInput = document.getElementById('exportFileName').value.trim();
        if (!fileNameInput) {
            showError('æ–‡ä»¶åä¸èƒ½ä¸ºç©º');
            return;
        }

        let finalFormat = exportFormat === 'current' ? currentFile?.format : exportFormat;
        if (!finalFormat) finalFormat = 'txt';

        let finalName = fileNameInput;
        if (!finalName.endsWith(`.${finalFormat}`)) {
            finalName += `.${finalFormat}`;
        }

        // æ ¼å¼éªŒè¯
        if (finalFormat === 'html' && !validateHTML(editor.value)) {
            showError('HTMLæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœªé—­åˆçš„æ ‡ç­¾');
            return;
        }

        // ç›´æ¥åˆ›å»ºBlobè¿›è¡Œä¸‹è½½ï¼ˆä¸å†ä¿®æ”¹currentFileï¼‰
        const content = currentFile?.format === 'hty' ? getCanvasDataURL() : editor.value; // Get canvas data for hty
        const blob = new Blob([content], {
            type: finalFormat === 'html' ? 'text/html' : (finalFormat === 'hty' ? 'image/png' : 'text/plain') // Export hty as png
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = finalName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showStatus(`å·²å¯¼å‡º: ${finalName}`);
        closeExportModal();
    }

    // æ¢å¤åŸæœ‰ä¸‹è½½å‡½æ•°é€»è¾‘
    function downloadFile() {
        if (!currentFile) return showError('æ²¡æœ‰å¯å¯¼å‡ºçš„æ–‡ä»¶');

        const content = currentFile?.format === 'hty' ? getCanvasDataURL() : editor.value; // Get canvas data for hty
        const blob = new Blob([content], {
            type: currentFile?.format === 'html' ? 'text/html' : (currentFile?.format === 'hty' ? 'image/png' : 'text/plain') // Download hty as png
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentFile.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showStatus('å·²ä¸‹è½½');
    }

    // HTMLåŸºç¡€éªŒè¯
    function validateHTML(content) {
        // æ£€æŸ¥æœªé—­åˆæ ‡ç­¾
        const tagRegex = /<(\/?[\w\d-]+)(?:\s+[^>]*)?>/g;
        const stack = [];
        let match;

        while ((match = tagRegex.exec(content)) !== null) {
            const tag = match[1].toLowerCase();
            if(tag.startsWith('/')) {
                const expected = stack.pop();
                if(!expected || expected !== tag.slice(1)) {
                    return false;
                }
            } else if(!['br','hr','img','input','meta','link'].includes(tag)) {
                stack.push(tag);
            }
        }

        return stack.length === 0;
    }

    // æ˜¾ç¤ºé”™è¯¯æç¤º
    function showError(message) {
        const toast = document.getElementById('errorToast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // ä¿®æ”¹ä¿å­˜åŠŸèƒ½
    function saveFile() {
        if(currentFile?.format === 'html' && !validateHTML(editor.value)) {
            showError('æ— æ³•ä¿å­˜ï¼šå­˜åœ¨æœªé—­åˆçš„HTMLæ ‡ç­¾');
            return;
        }

        // æ–°å¢å†…å®¹åŒæ­¥é€»è¾‘
        if (currentFile) {
            currentFile.content = currentFile.format === 'hty' ? getCanvasDataURL() : editor.value;  // åŒæ­¥ç¼–è¾‘å™¨å†…å®¹æˆ– canvas data
            const fileIndex = files.findIndex(f => f.id === currentFile.id);
            if (fileIndex > -1) {
                files[fileIndex] = currentFile;  // æ›´æ–°æ–‡ä»¶æ•°ç»„ä¸­çš„å¯¹åº”æ–‡ä»¶
            }
        }

        localStorage.setItem('editorFiles', JSON.stringify(files));
        showStatus('å·²ä¿å­˜');
        lastSavedContent = editor.value;
        document.title = `${currentFile.name} - ç°ä»£æ–‡æœ¬ç¼–è¾‘å™¨`;
    }

    // æ–°å¢é€€å‡ºåŠŸèƒ½
    function logout() {
        if(confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
            localStorage.removeItem('editorFiles');
            // è·³è½¬åˆ°ç™»å½•é¡µ
            window.location.href = 'Login.html';
        }
    }

    // ä¿®æ”¹ç¼–è¾‘å™¨è¾“å…¥å¤„ç†
    editor.addEventListener('keydown', (e) => {
        if (ideModeEnabled && e.key === 'Enter') {
            e.preventDefault();
            handleSmartIndent();
        }
    });

    // æ™ºèƒ½ç¼©è¿›å¤„ç†å‡½æ•°
    function handleSmartIndent() {
        const cursorPos = editor.selectionStart;
        const textBefore = editor.value.substring(0, cursorPos);

        // è·å–å½“å‰è¡Œèµ·å§‹ä½ç½®
        const lineStart = textBefore.lastIndexOf('\n', cursorPos - 1) + 1;
        const currentLine = textBefore.substring(lineStart);

        // è®¡ç®—ç¼©è¿›é‡
        const indent = currentLine.match(/^\s*/)[0];
        const newText = '\n' + indent;

        // æ’å…¥æ–°å†…å®¹
        editor.setRangeText(newText, cursorPos, cursorPos, 'end');

        // è§¦å‘è¾“å…¥äº‹ä»¶ä»¥ä¿æŒè‡ªåŠ¨ä¿å­˜
        const event = new Event('input', { bubbles: true });
        editor.dispatchEvent(event);
    }

    // æ–°å¢æœ¬åœ°æ–‡ä»¶æ“ä½œé€»è¾‘
    async function handleFileOpen() {
        try {
            [fileHandle] = await window.showOpenFilePicker({
                types: [{
                    description: 'æ–‡æœ¬æ–‡ä»¶',
                    accept: {'text/plain': ['.txt','.html','.md']}
                }]
            });

            const file = await fileHandle.getFile();
            const content = await file.text();

            const newFile = {
                id: `local_${Date.now()}`,
                name: file.name,
                content: content,
                format: file.name.split('.').pop(),
                isLocal: true
            };

            files.push(newFile);
            currentFile = newFile;
            editor.value = content;
            initFileList();
            showStatus(`å·²æ‰“å¼€æœ¬åœ°æ–‡ä»¶: ${file.name}`);
        } catch (err) {
            showError('æ–‡ä»¶æ“ä½œå·²å–æ¶ˆ');
        }
    }

    async function handleFileSave() {
        if (!currentFile?.isLocal) {
            return showError('ä»…æ”¯æŒä¿å­˜æœ¬åœ°æ–‡ä»¶');
        }

        try {
            const writable = await fileHandle.createWritable();
            await writable.write(editor.value);
            await writable.close();
            showStatus('æ–‡ä»¶å·²ä¿å­˜');
        } catch (err) {
            showError('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // æ–°å¢ä¸»é¢˜åˆ‡æ¢é€»è¾‘
    function toggleTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('editorTheme', theme);
    }

    // åˆå§‹åŒ–ä¸»é¢˜
    const savedTheme = localStorage.getItem('editorTheme') || 'dark';
    toggleTheme(savedTheme);

    // å®¡è®¡æ—¥å¿—é€»è¾‘
    let auditLogs = JSON.parse(localStorage.getItem('auditLogs')) || [];

    function logAction(type, fileName) {
        auditLogs.push({
            timestamp: new Date().toISOString(),
            type,
            fileName,
            user: localStorage.getItem('currentUser') || 'æœªç™»å½•ç”¨æˆ·'
        });
        localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
    }

    // æ˜¾ç¤ºå®¡è®¡æ—¥å¿—
    function showAuditLog() {
        const password = prompt('è¯·è¾“å…¥å®¡è®¡å¯†ç :');
        if (password !== 'Admin') {
            showError('æƒé™ä¸è¶³');
            return;
        }

        const logList = document.getElementById('auditLogList');
        logList.innerHTML = auditLogs.map(log => `
                <div style="padding: 8px; border-bottom: 1px solid var(--border-color);">
                    [${new Date(log.timestamp).toLocaleString()}]
                    ${log.type} ${log.fileName} - æ“ä½œäºº: ${log.user}
                </div>
            `).join('');
        document.getElementById('auditLogModal').style.display = 'flex';
    }

    function closeAuditModal() {
        document.getElementById('auditLogModal').style.display = 'none';
    }

    function updateAvatar() {
        const newPath = document.getElementById('avatarPath').value;
        if(newPath) {
            document.getElementById('userAvatar').src = newPath;
            localStorage.setItem('userAvatarPath', newPath);
            showStatus('å¤´åƒå·²æ›´æ–°');
        }
    }

    // åˆå§‹åŒ–ç”¨æˆ·è®¾ç½®
    const savedAvatarPath = localStorage.getItem('userAvatarPath');
    if(savedAvatarPath) {
        document.getElementById('userAvatar').src = savedAvatarPath;
    }

    // ä¿®æ”¹æ–°å»ºæ–‡ä»¶å¤¹è°ƒç”¨æ–¹å¼
    function createNewFolder() {
        showNewFolderModal();
    }

    // æ–°å¢æ–‡ä»¶å¤¹å¼¹çª—æ§åˆ¶å‡½æ•°
    function showNewFolderModal() {
        document.getElementById('folderNameInput').value = 'æ–°å»ºæ–‡ä»¶å¤¹';
        document.getElementById('newFolderModal').style.display = 'flex';
    }

    function closeNewFolderModal() {
        document.getElementById('newFolderModal').style.display = 'none';
    }

    // æ›´æ–°æ–‡ä»¶å¤¹åˆ›å»ºé€»è¾‘
    function confirmCreateFolder() {
        const folderName = document.getElementById('folderNameInput').value.trim();
        if (!folderName) {
            showError('æ–‡ä»¶å¤¹åç§°ä¸èƒ½ä¸ºç©º');
            return;
        }

        // æ£€æŸ¥åç§°å†²çª
        const existingNames = files.filter(f => f.type === 'folder').map(f => f.name);
        let finalName = folderName;
        let counter = 1;
        while (existingNames.includes(finalName)) {
            finalName = `${folderName} (${counter++})`;
        }

        const newFolder = {
            id: `folder_${Date.now()}`,
            name: finalName,
            type: 'folder',
            children: [],
            created: new Date().toISOString()
        };

        files.push(newFolder);
        localStorage.setItem('editorFiles', JSON.stringify(files));
        initFileList();
        closeNewFolderModal();
        showStatus('æ–‡ä»¶å¤¹å·²åˆ›å»º');
        logAction('CREATE_FOLDER', finalName);
    }

    // æ–°å¢è¡Œå·æ˜¾ç¤ºçŠ¶æ€
    let lineNumbersEnabled = false;
    const lineNumberToggle = document.getElementById('lineNumberToggle');
    const lineNumbers = document.getElementById('lineNumbers');

    // åˆå§‹åŒ–è¡Œå·çŠ¶æ€
    lineNumberToggle.addEventListener('change', function() {
        lineNumbersEnabled = this.checked;
        lineNumbers.style.display = lineNumbersEnabled ? 'block' : 'none';
        updateLineNumbers();
        localStorage.setItem('lineNumbersEnabled', lineNumbersEnabled);
    });

    // åˆå§‹åŒ–æ—¶è¯»å–å­˜å‚¨çŠ¶æ€
    const savedLineNumbers = localStorage.getItem('lineNumbersEnabled') === 'true';
    lineNumberToggle.checked = savedLineNumbers;
    lineNumbers.style.display = savedLineNumbers ? 'block' : 'none';

    // æ›´æ–°è¡Œå·é€»è¾‘
    function updateLineNumbers() {
        if (!lineNumbersEnabled) return;

        const lines = editor.value.split('\n');
        const cursorPos = editor.selectionStart;
        const textBeforeCursor = editor.value.substr(0, cursorPos);
        const currentLine = textBeforeCursor.split('\n').length;

        lineNumbers.innerHTML = lines
            .map((_, i) => `
                    <div class="${i + 1 === currentLine ? 'active-line' : ''}">
                        ${i + 1}
                    </div>
                `).join('');
    }

    // æ·»åŠ èŠ‚æµæ»šåŠ¨å¤„ç†
    let isScrolling = false;
    editor.addEventListener('scroll', () => {
        if (!isScrolling) {
            window.requestAnimationFrame(() => {
                lineNumbers.scrollTop = editor.scrollTop;
                isScrolling = false;
            });
            isScrolling = true;
        }
    });

    // æ·»åŠ çª—å£å¤§å°å˜åŒ–ç›‘å¬
    window.addEventListener('resize', () => {
        lineNumbers.style.height = `${editor.offsetHeight}px`;
        const lineHeight = getComputedStyle(editor).lineHeight;
        lineNumbers.style.lineHeight = lineHeight; // åŒæ­¥è¡Œé«˜
    });

    // ç›‘å¬ç¼–è¾‘å™¨è¾“å…¥
    editor.addEventListener('input', () => {
        updateLineNumbers();
        // ... existing input handling ...
    });

    // æ–°å¢æœç´¢ç›¸å…³çŠ¶æ€
    let searchMatches = [];
    let currentMatchIndex = -1;
    let caseSensitive = false;

    // æ–°å¢æœç´¢é¢æ¿äº¤äº’é€»è¾‘
    let dragData = {
        isDragging: false,
        startX: 0,
        startY: 0,
        initialX: 0,
        initialY: 0
    };

    function toggleSearchPanel() {
        const isVisible = searchPanel.style.display === 'block';
        searchPanel.style.display = isVisible ? 'none' : 'block';
        searchPanelToggle.checked = !isVisible;

        if (!isVisible) {
            searchInput.focus();
        }
        localStorage.setItem('searchPanelState', !isVisible);
    }

    // åˆå§‹åŒ–æ—¶è¯»å–é¢æ¿çŠ¶æ€
    const savedPanelState = localStorage.getItem('searchPanelState') === 'true';
    searchPanelToggle.checked = savedPanelState;
    searchPanel.style.display = savedPanelState ? 'block' : 'none';

    // ä¿®æ”¹å¿«æ·é”®å¤„ç†
    editor.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            searchPanelToggle.click(); // åˆ‡æ¢å¼€å…³çŠ¶æ€
        }
    });

    // æ‰§è¡Œæœç´¢
    function performSearch() {
        const searchText = searchInput.value;
        if (!searchText) {
            clearHighlights();
            return;
        }

        const flags = caseSensitive ? 'g' : 'gi';
        const regex = new RegExp(escapeRegExp(searchText), flags);

        // è·å–ç¼–è¾‘å™¨å†…å®¹
        const content = editor.value;
        searchMatches = [];

        // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…é¡¹
        let match;
        while ((match = regex.exec(content)) !== null) {
            searchMatches.push({
                start: match.index,
                end: match.index + match[0].length
            });
        }

        updateHighlights();
        updateMatchesDisplay();
    }

    // æ›´æ–°é«˜äº®æ˜¾ç¤º
    function updateHighlights() {
        clearHighlights();

        const content = editor.value;
        let highlightedContent = content;
        let offset = 0;

        searchMatches.forEach((match, index) => {
            const start = match.start + offset;
            const end = match.end + offset;
            const highlightClass = index === currentMatchIndex ?
                'current-highlight' : 'highlight';

            highlightedContent =
                highlightedContent.slice(0, start) +
                `<span class="${highlightClass}">` +
                highlightedContent.slice(start, end) +
                '</span>' +
                highlightedContent.slice(end);

            offset += 27 + highlightClass.length; // è¡¥å¿æ’å…¥çš„HTMLé•¿åº¦
        });

        // ä½¿ç”¨ä¸´æ—¶divä¿æŒæ»šåŠ¨ä½ç½®
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = highlightedContent;
        editor.nextSibling.innerHTML = tempDiv.innerHTML;
    }

    // æ¸…é™¤é«˜äº®
    function clearHighlights() {
        const spans = editor.nextSibling.querySelectorAll('span');
        spans.forEach(span => {
            const parent = span.parentNode;
            while (span.firstChild) parent.insertBefore(span.firstChild, span);
            parent.removeChild(span);
        });
        currentMatchIndex = -1;
    }

    // æ›´æ–°åŒ¹é…è®¡æ•°æ˜¾ç¤º
    function updateMatchesDisplay() {
        const total = searchMatches.length;
        const current = total > 0 ? currentMatchIndex + 1 : 0;
        matchesDisplay.textContent = `${current}/${total}`;
    }

    // æŸ¥æ‰¾ä¸‹ä¸€ä¸ª
    function findNext() {
        if (searchMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length;
        scrollToMatch();
        updateHighlights();
    }

    // æŸ¥æ‰¾ä¸Šä¸€ä¸ª
    function findPrev() {
        if (searchMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex - 1 + searchMatches.length) % searchMatches.length;
        scrollToMatch();
        updateHighlights();
    }

    // æ»šåŠ¨åˆ°å½“å‰åŒ¹é…é¡¹
    function scrollToMatch() {
        if (currentMatchIndex === -1) return;

        const match = searchMatches[currentMatchIndex];
        const line = editor.value.substr(0, match.start).split('\n').length - 1;
        const lineHeight = parseInt(getComputedStyle(editor).lineHeight);
        editor.scrollTop = line * lineHeight - editor.offsetHeight / 2;
    }

    // å·¥å…·å‡½æ•°ï¼šè½¬ä¹‰æ­£åˆ™ç‰¹æ®Šå­—ç¬¦
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // äº‹ä»¶ç›‘å¬
    searchInput.addEventListener('input', () => {
        performSearch();
    });

    caseSensitiveToggle.addEventListener('change', function() {
        caseSensitive = this.checked;
        performSearch();
    });

    // ä¿®æ”¹æ‹–åŠ¨å¤„ç†é€»è¾‘
    searchPanel.addEventListener('mousedown', (e) => {
        // ä»…å…è®¸é€šè¿‡æ ‡é¢˜æ æ‹–åŠ¨
        const header = e.target.closest('.search-panel-header');
        if (!header) return;

        dragData = {
            isDragging: true,
            startX: e.clientX,
            startY: e.clientY,
            initialX: searchPanel.offsetLeft,
            initialY: searchPanel.offsetTop
        };

        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', stopDrag);
    });

    function handleDrag(e) {
        if (!dragData.isDragging) return;

        const dx = e.clientX - dragData.startX;
        const dy = e.clientY - dragData.startY;

        searchPanel.style.left = `${dragData.initialX + dx}px`;
        searchPanel.style.top = `${dragData.initialY + dy}px`;
    }

    function stopDrag() {
        dragData.isDragging = false;
        document.removeEventListener('mousemove', handleDrag);
        document.removeEventListener('mouseup', stopDrag);
    }

    // æ–°å¢å­—ä½“æ§åˆ¶é€»è¾‘
    function updateFontSize(size) {
        document.documentElement.style.setProperty('--editor-font-size', `${size}px`);
        localStorage.setItem('editorFontSize', size);
    }

    function updateFontFamily(font) {
        document.documentElement.style.setProperty('--editor-font-family', font);
        localStorage.setItem('editorFontFamily', font);
    }

    // åˆå§‹åŒ–å­—ä½“è®¾ç½®
    const savedFontSize = localStorage.getItem('editorFontSize') || '16';
    const savedFontFamily = localStorage.getItem('editorFontFamily') || 'system-ui';
    document.getElementById('fontSizeSelect').value = savedFontSize;
    document.getElementById('fontFamilySelect').value = savedFontFamily;
    updateFontSize(savedFontSize);
    updateFontFamily(savedFontFamily);

    // æ–°å¢æ¸…é™¤æ—¥å¿—å¤„ç†å‡½æ•°
    function handleClearLogs() {
        const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :');
        if (password !== 'Admin') {
            showError('å¯†ç é”™è¯¯');
            return;
        }

        auditLogs = [];
        localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
        refreshLogList();
        showStatus('æ—¥å¿—å·²æ¸…é™¤');
    }

    // ä¿®æ”¹åçš„æ—¥å¿—åˆ·æ–°å‡½æ•°
    function refreshLogList() {
        const logList = document.getElementById('auditLogList');
        logList.innerHTML = auditLogs.map(log => `
                <div class="log-item" style="padding: 12px; margin-bottom: 8px; background: var(--secondary-bg); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary); font-size: 12px;">
                            ${new Date(log.timestamp).toLocaleString()}
                        </span>
                        <span style="color: var(--accent-blue); font-weight: 500;">
                            ${log.type.replace(/_/g, ' ')}
                        </span>
                    </div>
                    <div style="margin-top: 6px;">${log.fileName || 'ç³»ç»Ÿæ“ä½œ'}</div>
                    <div style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">
                        æ“ä½œäºº: ${log.user || 'æœªç™»å½•ç”¨æˆ·'}
                    </div>
                </div>
            `).join('');
    }

    // ä¿®æ”¹ç”¨æˆ·åä¿å­˜é€»è¾‘
    function saveUserName() {
        const userName = document.getElementById('userNameInput').value.trim();
        if (!userName) {
            showError('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
            return;
        }
        localStorage.setItem('currentUser', userName);
        document.getElementById('username').textContent = userName; // åŒæ­¥æ›´æ–°å·¦ä¸Šè§’æ˜¾ç¤º
        showStatus('ç”¨æˆ·å·²è®¾ç½®ä¸º: ' + userName);
    }

    // åˆå§‹åŒ–æ—¶æ›´æ–°å·¦ä¸Šè§’ç”¨æˆ·å
    const currentUser = localStorage.getItem('currentUser') || 'æœªç™»å½•ç”¨æˆ·';
    document.getElementById('userNameInput').value = currentUser;
    document.getElementById('username').textContent = currentUser;

    // æ–°å¢æ‹¼å†™æ£€æŸ¥å¼€å…³å¤„ç†å‡½æ•°
    function toggleSpellCheck() {
        const enabled = document.getElementById('spellCheckToggle').checked;
        editor.spellcheck = enabled;
        localStorage.setItem('spellCheckEnabled', enabled);
        showStatus(`æ‹¼å†™æ£€æŸ¥å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
    }

    // åˆå§‹åŒ–æ‹¼å†™æ£€æŸ¥çŠ¶æ€
    const savedSpellCheck = localStorage.getItem('spellCheckEnabled');
    const spellCheckEnabled = savedSpellCheck !== null ? savedSpellCheck === 'true' : true;
    document.getElementById('spellCheckToggle').checked = spellCheckEnabled;
    editor.spellcheck = spellCheckEnabled;

    let sidebarExpanded = false;
    let toolbarExpanded = false;

    function toggleSidebar() {
        const container = document.querySelector('.container');
        const button = document.getElementById('sidebarToggleButton');
        const sidebarToggleBar = document.getElementById('sidebarToggleBar');

        if (sidebarExpanded) {
            container.classList.remove('sidebar-expanded');
            sidebarExpanded = false;
            button.textContent = 'å±•å¼€å·¦ä¾§';
            sidebarToggleBar.style.display = 'block'; // æ˜¾ç¤ºå±•å¼€æ¡
        } else {
            // å¦‚æœå³ä¾§å·²å±•å¼€ï¼Œå…ˆæŠ˜å å³ä¾§
            if (toolbarExpanded) {
                toggleToolbar();
            }
            container.classList.add('sidebar-expanded');
            sidebarExpanded = true;
            button.textContent = 'æŠ˜å å·¦ä¾§';
            sidebarToggleBar.style.display = 'none'; // éšè—å±•å¼€æ¡
        }
    }

    function toggleToolbar() {
        const container = document.querySelector('.container');
        const button = document.getElementById('toolbarToggleButton');
        const toolbarToggleBar = document.getElementById('toolbarToggleBar');
        const toolbar = document.querySelector('.toolbar'); // è·å–toolbarå…ƒç´ 

        if (toolbarExpanded) {
            container.classList.remove('toolbar-expanded');
            toolbarExpanded = false;
            button.textContent = 'å±•å¼€å³ä¾§';
            toolbarToggleBar.style.display = 'block'; // æ˜¾ç¤ºå±•å¼€æ¡
        } else {
            // å¦‚æœå·¦ä¾§å·²å±•å¼€ï¼Œå…ˆæŠ˜å å·¦ä¾§
            if (sidebarExpanded) {
                toggleSidebar();
            }
            container.classList.add('toolbar-expanded');
            toolbarExpanded = true;
            button.textContent = 'æŠ˜å å³ä¾§';
            toolbarToggleBar.style.display = 'none'; // éšè—å±•å¼€æ¡
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å±å¹•å®½åº¦
    window.addEventListener('load', () => {
        if (window.innerWidth <= 768) {
            // é»˜è®¤æŠ˜å å·¦å³ä¸¤ä¾§
            const container = document.querySelector('.container');
            container.classList.remove('sidebar-expanded', 'toolbar-expanded');
            sidebarExpanded = false;
            toolbarExpanded = false;

            // æ‰‹æœºæ¨¡å¼ä¸‹æ˜¾ç¤ºå±•å¼€æ¡
            document.getElementById('sidebarToggleBar').style.display = 'block';
            document.getElementById('toolbarToggleBar').style.display = 'block';
        }
    });

    // Canvas drawing variables
    const htyCanvas = document.getElementById('htyCanvas');
    const ctx = htyCanvas.getContext('2d');
    let drawing = false;
    let currentPos = { x: 0, y: 0 };
    let lastPos = { x: 0, y: 0 };
    let penColor = '#000000'; // Default pen color black
    let zoomLevel = 1; // Initialize zoom level to 1 (no zoom)

    function switchToCanvasMode() {
        editor.style.display = 'none';
        lineNumbers.style.display = 'none';
        htyCanvas.style.display = 'block';
        htyCanvas.style.backgroundColor = 'white'; // Set canvas background to white
    }

    function switchToEditorMode() {
        editor.style.display = 'block';
        lineNumbers.style.display = lineNumberToggle.checked ? 'block' : 'none';
        htyCanvas.style.display = 'none';
        document.querySelector('.editor-container').style.backgroundColor = ''; // Revert to default background
    }

    htyCanvas.addEventListener('mousedown', startDrawing);
    htyCanvas.addEventListener('mouseup', stopDrawing);
    htyCanvas.addEventListener('mouseout', stopDrawing);
    htyCanvas.addEventListener('mousemove', draw);
    htyCanvas.addEventListener('wheel', handleWheelZoom); // Add wheel event listener

    function getMousePos(canvas, evt) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: (evt.clientX - rect.left) / zoomLevel, // é™¤ä»¥ zoomLevel
            y: (evt.clientY - rect.top) / zoomLevel  // é™¤ä»¥ zoomLevel
        };
    }

    function startDrawing(e) {
        drawing = true;
        lastPos = getMousePos(htyCanvas, e);
    }

    function stopDrawing() {
        drawing = false;
    }

    function draw(e) {
        if (!drawing) return;

        currentPos = getMousePos(htyCanvas, e);

        ctx.beginPath();
        ctx.moveTo(lastPos.x, lastPos.y);
        ctx.lineTo(currentPos.x, currentPos.y);
        ctx.strokeStyle = penColor; // Use current pen color
        ctx.lineWidth = 2; // Default line width
        ctx.lineCap = 'round';
        ctx.stroke();

        lastPos = currentPos;
    }

    function handleWheelZoom(e) {
        e.preventDefault(); // Prevent page scroll

        const zoomSpeed = 0.1;
        if (e.deltaY < 0) {
            zoomLevel += zoomSpeed; // Zoom in
        } else {
            zoomLevel -= zoomSpeed; // Zoom out
        }
        zoomLevel = Math.max(0.1, zoomLevel); // Prevent zoom level from becoming too small

        const mousePos = getMousePos(htyCanvas, e); // Get mouse position
        const mouseX = mousePos.x;
        const mouseY = mousePos.y;

        ctx.clearRect(0, 0, htyCanvas.width, htyCanvas.height); // Clear canvas

        // Apply zoom and translate to zoom around mouse cursor
        ctx.translate(mouseX, mouseY);       // Translate to mouse position
        ctx.scale(zoomLevel, zoomLevel);     // Scale around mouse position
        ctx.translate(-mouseX, -mouseY);      // Translate back

        loadCanvasContent(currentFile.content); // Redraw the content at new zoom level
    }

    function getCanvasDataURL() {
        return htyCanvas.toDataURL('image/png');
    }

    function loadCanvasContent(dataURL) {
        if (!dataURL) return;
        const img = new Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0);
        };
        img.src = dataURL;
    }

    // Pen color change listener
    document.getElementById('penColorPicker').addEventListener('input', (e) => {
        penColor = e.target.value;
    });
</script>
</body>
</html>
